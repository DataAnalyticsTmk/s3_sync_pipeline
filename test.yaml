version: 0.2

phases:
  pre_build:
    commands:
      - echo Nothing to do in the pre_build phase...
  build:
    commands:
      - echo Build started on `date`
      - #
      - echo ${SPECIFIC_FOLDER}
      - |
        #!/bin/bash
        if [ -z "$SPECIFIC_FOLDER_PATH" ]; then
          echo "Starting full s3 sync..."
          aws s3 cp s3://aws-glue-assets-970892252496-us-east-1/codebuild/sync_list.json .
          LIST=$(cat sync_list.json|jq -r 'keys[]'| xargs)
            for div in $LIST
            do
            echo "Starting sync for ${div}"
            aws s3 sync s3://dev-dl-970892252496-us-east-1-raw/consolidated_raw/${div}/ s3://dev-dl-970892252496-us-east-1-conformed/sync_test/${div}/ --delete
            done
           TABLES_LIST=$(cat sync_list.json|jq -r '.[]'|xargs)
           echo $TABLES_LIST
             for table in $TABLES_LIST
             do
             echo "Starting msck for ${table}"
             queryExecutionId=$(aws athena --region us-east-1 start-query-execution --query-string "MSCK REPAIR TABLE $table" --query-execution-context Database=publish_sync_test --result-configuration OutputLocation=s3://dev-dl-970892252496-us-east-1-queries | jq -r '.QueryExecutionId')
             echo "queryExecutionId was ${queryExecutionId}"
                for i in $(seq 1 30); do
            queryState=$(aws athena get-query-execution --query-execution-id "${queryExecutionId}"  --region us-east-1 | jq -r ".QueryExecution.Status.State");
                if [[ "${queryState}" == "SUCCEEDED" ]]; then
                break;
                fi;
                echo "Awaiting queryExecutionId ${queryExecutionId} - state was ${queryState}"
                if [[ "${queryState}" == "FAILED" ]]; then
            # exit with "bad" error code
                        exit 1;
                fi;
                    sleep 2
                done
             done
        else
          echo "Starting sync for only provided s3 folder path $SPECIFIC_FOLDER_PATH"
          #aws s3 sync s3://dev-dl-970892252496-us-east-1-raw/consolidated_raw/${div}/ s3://dev-dl-970892252496-us-east-1-conformed/sync_test/${div}/ --delete
        fi
  post_build:
    commands:
      - echo Build completed on `date`

  
